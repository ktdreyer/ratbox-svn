# $Id$

CC=@CC@
RM=@RM@
MV=@MV@
INSTALL=@INSTALL@
LEX=@LEX@
LEXLIB=@LEXLIB@
YACC=@YACC@
PREFIX=@prefix@
BIN=rserv@EXEEXT@
INCLUDES=-I ../include/
LDFLAGS=
LIBS=@LIBS@
CFLAGS=-g -O0 -Wall -Werror -Wunused -Wshadow -Wmissing-declarations -Wwrite-strings -DPREFIX=\"$(PREFIX)\"
MAKE = make

SERVICEDIRS=s_userserv s_chanserv
SERVICELIBS=s_userserv.a s_chanserv.a

# Anything marked with the .PHONY attribute is always considered "out of date"
.PHONY: $(BIN)

SRCS = 			\
        balloc.c        \
        c_error.c       \
	c_message.c	\
	c_mode.c	\
        cache.c         \
	channel.c	\
	client.c	\
	conf.c		\
	event.c		\
	fileio.c	\
	hook.c		\
	io.c		\
	log.c		\
	match.c		\
        newconf.c       \
	rserv.c		\
	s_alis.c	\
	s_operbot.c	\
	scommand.c	\
	service.c	\
	tools.c		\
        u_stats.c       \
	ucommand.c

OBJS=$(SRCS:.c=.o)

all: $(BIN)

$(BIN): $(OBJS) y.tab.o lex.yy.o
	@for i in $(SERVICEDIRS); do \
		echo "build -> $$i"; \
		cd $$i; \
		$(MAKE) build || exit; cd ..; \
	done

	${CC} ${CFLAGS} ${LDFLAGS} -o $@ ${OBJS} y.tab.o lex.yy.o -L . $(SERVICELIBS) $(LIBS) $(LEXLIB)

.c.o:
	${CC} $(INCLUDES) ${CFLAGS} -c $<

y.tab.o:	y.tab.c parser.y
	$(CC) $(INCLUDES) -I. $(CFLAGS) -c y.tab.c

y.tab.c:	parser.y
	$(YACC) -d parser.y

lex.yy.o:	lex.yy.c lexer.l
	$(CC) $(INCLUDES) -I. $(CFLAGS) -c lex.yy.c

lex.yy.c:	lexer.l
	$(LEX) lexer.l

build: $(BIN)

clean:
	@for i in $(SERVICEDIRS); do \
		cd $$i; \
		$(MAKE) clean || exit; cd ..; \
	done

	$(RM) -f $(BIN) *.o y.tab.* lex.yy.c

distclean: clean
	@for i in $(SERVICEDIRS); do \
		cd $$i; \
		$(MAKE) distclean || exit; cd ..; \
	done

	$(RM) Makefile

depend:
	$(CC) -MM $(INCLUDES) $(CFLAGS) $(SRCS) > .depend

install:

include .depend
